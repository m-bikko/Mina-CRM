Идея проекта: Разработка простой CRM для магазина женской одежды
Административная часть:

1) Каталог товаров Каждый товар должен содержать следующие атрибуты:

- Название (Name)

- Размеры (Sizes): Множественные данные (например, S, M, L), которые вводятся/создаются вручную. Также должна быть реализована функция для указания конкретных параметров (замеров) для каждого размера. Пример структуры: [{name_of_parameter: "обхват груди", size: "88см"}]

- Цена продажи (Selling Price)

- Фотографии (Photos): Множественные данные (массив ссылок). Для хранения изображений будет использоваться сервис Cloudinary, в базе данных храним ссылки.

Пример для mongodb:
{
  "_id": "650c...",
  "name": "Летнее платье в цветочек",
  "price": 15000,
  "images": [
    "https://res.cloudinary.com/demo/image/upload/v1/dress-front.jpg",
    "https://res.cloudinary.com/demo/image/upload/v1/dress-back.jpg"
  ],
  "sizes": [
    {
      "label": "S",
      "measurements": [
        { "parameterName": "chest", "value": "84cm" },
        { "parameterName": "waist", "value": "62cm" },
        { "parameterName": "length", "value": "90cm" }
      ],
      "quantity": 1
    },
    {
      "label": "M",
      "measurements": [
        { "parameterName": "chest", "value": "88cm" },
        { "parameterName": "waist", "value": "66cm" },
        { "parameterName": "length", "value": "92cm" }
      ],
      "quantity": 1
    }
  ],
  "isActive": true,
  "createdAt": "2025-12-14T10:00:00.000Z",
  "updatedAt": "2025-12-14T10:00:00.000Z"
}

Функционал этой части:
- Добавление нового товара.
- Редактирование товара.
- Удаление товара.
- Просмотр списка товаров в административной панели. Сделать в виде списка и карточек. Мы должны иметь возможность переключать эти виды
- Возможность изменения размера

Требования к дизайну, супер чистый UI для понятного интерфейса Админской части
--------------------------------------------------
То что ты видишь сверху, уже сделано и не подлежит к изменению
--------------------------------------------------

# Техническое задание: Складской учет и Финансы (Amina CRM)

## 1\. Архитектура Базы Данных (MongoDB / Mongoose)

Необходимо создать 4 новые коллекции и обновить существующую модель `Product`.

### 1.1. Обновление `Product` (Товары)

В существующую модель добавляется только логика изменения поля `quantity` внутри массива `sizes`. Структура остается прежней, но мы будем часто обращаться к ней для атомарных обновлений (`$inc`).

### 1.2. Новая модель `PaymentType` (Типы оплаты)

Справочник для хранения способов оплаты и налоговых ставок.

```typescript
// models/PaymentType.ts
{
  name: string;        // Например: "Kaspi QR", "Наличные"
  taxRate: number;     // Процент налога (например, 3 для 3%)
  isActive: boolean;   // Для возможности скрыть старые типы
  createdAt: Date;
}
```

### 1.3. Новая модель `Supply` (Завозы)

Хранит историю поступления товаров.

```typescript
// models/Supply.ts
{
  date: Date;             // Дата завоза
  items: [
    {
      product: ObjectId;  // Ссылка на Product
      productName: string;// Снэпшот названия (на случай удаления товара)
      sizeLabel: string;  // Размер (S, M)
      quantity: number;   // Кол-во прихода
      costPrice: number;  // Цена закупа за единицу (себестоимость)
    }
  ];
  totalCost: number;      // Общая сумма затрат на завоз (вычитается из баланса)
}
```

### 1.4. Новая модель `Sale` (Продажи)

Хранит историю продаж.

```typescript
// models/Sale.ts
{
  date: Date;
  customerPhone: string;     // Номер клиента (общий для чека)
  paymentType: ObjectId;     // Ссылка на PaymentType
  paymentTypeName: string;   // Снэпшот названия оплаты
  taxRateSnapshot: number;   // Снэпшот процента налога на момент продажи
  items: [
    {
      product: ObjectId;     // Ссылка на Product
      productName: string;
      sizeLabel: string;
      quantity: number;
      priceAtSale: number;   // Цена продажи за единицу на момент сделки
    }
  ];
  totalAmount: number;       // Итоговая сумма продажи (добавляется в баланс)
  taxAmount: number;         // Рассчитанный налог (totalAmount * taxRateSnapshot / 100)
}
```

### 1.5. Новая модель `Transaction` (Финансовый журнал)

Единый журнал для всех движений денег (для построения истории баланса).

```typescript
// models/Transaction.ts
{
  type: 'INCOME' | 'EXPENSE'; // Доход или Расход
  category: 'SALE' | 'SUPPLY' | 'MANUAL_ADJUSTMENT'; // Продажа, Завоз, Ручное
  amount: number;             // Сумма
  reason: string;             // Описание (например, "Завоз от 14.12", "Корректировка кассы")
  referenceId?: ObjectId;     // Ссылка на ID Sale или Supply (если есть)
  date: Date;
}
```

### 1.6. Синглтон `FinancialStats` (Опционально, но рекомендуется)

Чтобы каждый раз не пересчитывать баланс по всем транзакциям, храним текущее состояние.

```typescript
{
  currentBalance: number; // Текущие деньги в кассе
  updatedAt: Date;
}
```

-----

## 2\. Бизнес-логика и API Endpoints

Все расчеты должны происходить на сервере (в API роутах), чтобы избежать ошибок на клиенте.

### 2.1. Модуль: Типы оплаты

  * **GET /api/payment-types**: Получить список активных типов.
  * **POST /api/payment-types**: Создать новый тип.
      * *Body:* `{ name, taxRate }`.

### 2.2. Модуль: Завоз (Supply)

  * **POST /api/supplies**
      * *Логика:*
        1.  **Транзакция БД (Session):** Начать сессию MongoDB.
        2.  Создать документ `Supply`.
        3.  **Цикл по товарам:** Для каждого товара найти документ `Product` и сделать `$inc` (инкремент) для поля `quantity` соответствующего размера.
        4.  Рассчитать `totalCost` (сумма всех `qty * costPrice`).
        5.  Обновить `FinancialStats`: `$inc: { currentBalance: -totalCost }` (минус баланс).
        6.  Создать запись `Transaction`: `{ type: 'EXPENSE', category: 'SUPPLY', amount: totalCost }`.
        7.  Закоммитить транзакцию.

### 2.3. Модуль: Продажи (Sales)

  * **POST /api/sales**
      * *Валидация:* Перед продажей проверить, достаточно ли товара (`quantity`) на складе.
      * *Логика:*
        1.  **Транзакция БД (Session):** Начать сессию.
        2.  Получить `taxRate` из выбранного `PaymentType`.
        3.  Создать документ `Sale`. Рассчитать `taxAmount`.
        4.  **Цикл по товарам:** Для каждого товара сделать `$inc` (декремент -1) для поля `quantity`.
        5.  Рассчитать `totalAmount` (сумма `qty * sellingPrice`).
        6.  Обновить `FinancialStats`: `$inc: { currentBalance: +totalAmount }` (плюс баланс).
        7.  Создать запись `Transaction`: `{ type: 'INCOME', category: 'SALE', amount: totalAmount }`.
        8.  Закоммитить транзакцию.

### 2.4. Модуль: Баланс (Ручные операции и история)

  * **POST /api/finance/adjustment**
      * *Body:* `{ type: 'INCOME' | 'EXPENSE', amount, reason }`
      * *Логика:*
        1.  Создать `Transaction`.
        2.  Обновить `FinancialStats` (плюс или минус в зависимости от типа).
  * **GET /api/finance/history**
      * Возвращает список `Transaction` с пагинацией.
      * При клике на транзакцию с `category: 'SALE'` или `'SUPPLY'` фронтенд должен делать доп. запрос к `/api/sales/:id` или `/api/supplies/:id` для деталей.

### 2.5. Модуль: Dashboard (Аналитика)

  * **GET /api/dashboard**
      * Возвращает объект:
        1.  `balance`: Берем из `FinancialStats.currentBalance`.
        2.  `taxPayable`: Агрегация по коллекции `Sale` -\> сумма полей `taxAmount`.
        3.  `capital`:
              * Берем `balance`.
              * Плюс агрегация по всем `Product`: Сумма `(size.quantity * product.price)`.
              * *Формула:* Капитал = Деньги в кассе + Товар в наличии по цене продажи.
        4.  `salesChart`: Агрегация `Sale` по датам (group by day) за выбранный период.

-----

## 3\. Требования к UI (Frontend)

Использовать **Shadcn UI** (на базе Radix + Tailwind) для сохранения "супер чистого стиля".

### 3.1. Страница "Завоз" (`/admin/supply`)

  * **Кнопка "Создать завоз"**: Открывает Dialog (модалку).
  * **Модальное окно**:
      * `Select` для выбора товара (с поиском).
      * После выбора: отображается список доступных размеров этого товара.
      * Напротив каждого размера: `Input` (Кол-во) и `Input` (Цена закупа).
      * Кнопка "Добавить еще товар" (чтобы в один завоз включить разные артикулы).
      * Итоговая сумма завоза (авто-расчет).
  * **Таблица**: Дата, Кол-во позиций, Общая сумма.

### 3.2. Страница "Продажи" (`/admin/sales`)

  * **Кнопка "Новая продажа"**: Открывает Dialog.
  * **Модальное окно**:
      * Верхняя часть: `Input` (Номер покупателя), `Select` (Тип оплаты).
      * Динамический список товаров:
          * Выбор товара -\> Выбор размера -\> `Input` (Кол-во).
          * *Важно:* Показывать подсказку "Доступно: X шт."
      * Авто-расчет "К оплате".
  * **Таблица**: Дата, Клиент, Тип оплаты, Сумма, Детали (кнопка раскрытия).

### 3.3. Страница "Баланс" (`/admin/finance`)

  * **Карточки (верх)**: Текущий баланс.
  * **Кнопки действий**:
      * [+] Пополнить (Зеленая): Модалка (Сумма, Обоснование).
      * [-] Снять (Красная): Модалка (Сумма, Обоснование).
  * **Таблица истории**:
      * Колонки: Дата, Тип (Иконка стрелки вверх/вниз), Категория, Обоснование/ID, Сумма.
      * При клике на строку "Продажа" или "Завоз" открывается `Sheet` (боковая панель) или `Dialog` с составом чека/накладной.

### 3.4. Главная (Dashboard)

  * **Grid Layout (4 карточки)**:
    1.  **Баланс** (Крупная цифра).
    2.  **Капитал** (С тултипом: "Баланс + Стоимость всех товаров").
    3.  **Налог к уплате** (Накопительным итогом).
    4.  **Продажи сегодня** (Кол-во чеков / Сумма).
  * **График (Recharts или Chart.js)**:
      * Линейный график или Бары.
      * Ось X: Дни.
      * Ось Y: Сумма продаж.
      * Фильтр: Неделя / Месяц.

-----

## 4\. План реализации (по шагам)

1.  **База данных:** Создать Mongoose схемы (`PaymentType`, `Supply`, `Sale`, `Transaction`).
2.  **API Справочников:** Реализовать CRUD для Типов оплаты.
3.  **API Склад:** Реализовать POST `/api/supplies` (завоз) с обновлением остатков.
4.  **API Продажи:** Реализовать POST `/api/sales` с проверкой остатков и списанием.
5.  **API Финансы:** Реализовать ручные транзакции и подсчет баланса.
6.  **Frontend:** Верстка модальных окон (самая сложная часть — динамические формы товаров/размеров).
7.  **Dashboard:** Сбор данных в кучу и отрисовка графика.

### Пример расчета Капитала (код для разработчика)

```typescript
// В API роуте Dashboard
const products = await Product.find({ isActive: true });
let inventoryValue = 0;

products.forEach(product => {
  product.sizes.forEach(size => {
    // Цена товара * кол-во этого размера
    inventoryValue += (product.price * size.quantity);
  });
});

const capital = currentBalance + inventoryValue;
```